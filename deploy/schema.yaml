x-google-marketplace:
  schemaVersion: v2
  applicationApiVersion: v1beta1

  publishedVersion: "2.3.0"
  publishedVersionMetadata:
    releaseNote: >
      ElexRatio v2.3.0 - All images updated with Docker manifest v2 schema and Marketplace annotations.
      Includes all components: kat-api, ktaiflow-api, kat-admin-studio, kat-dynamic-portal, and ktaiflow-ui.
      Fixed: Added reportingSecret for usage-based billing, expanded RBAC permissions, and corrected image paths to Marketplace standard (under deployer/).
    recommended: true

  managedUpdates:
    kalmSupported: false

  images:
    '':
      properties:
        image.registry:
          type: REGISTRY
        image.repository:
          type: REPO_WITHOUT_REGISTRY
        image.tag:
          type: TAG

properties:
  APP_INSTANCE_NAME:
    type: string
    default: "elexratio"
    pattern: "^[a-z0-9-]+$"
    x-google-marketplace:
      type: NAME

  NAMESPACE:
    type: string
    default: "kat"
    x-google-marketplace:
      type: NAMESPACE

  DOMAIN:
    type: string
    pattern: "^[a-zA-Z0-9.-]+$"
    default: "elexratio.example.com"

  # CRITICAL FIX #1: Added reportingSecret for usage-based billing
  reportingSecret:
    type: string
    x-google-marketplace:
      type: REPORTING_SECRET

  # Image configurations - ALL under deployer/ path (Marketplace standard)
  deployer.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer:2.3.0-amd64
    x-google-marketplace:
      type: DEPLOYER_IMAGE

  katApi.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer/kat-api:2.3.0-amd64

  ktaiflowApi.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer/ktaiflow-api:2.3.0-amd64

  katDynamicPortal.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer/kat-dynamic-portal:2.3.0-amd64

  katAdminStudio.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer/kat-admin-studio:2.3.0-amd64

  ktaiflowUi.image:
    type: string
    default: us-docker.pkg.dev/able-decorator-477323-u6/gcr.io/elexratio/deployer/ktaiflow-ui:2.3.0-amd64

  deployerServiceAccount:
    type: string
    title: Service Account for deployer
    default: "deployer-sa"
    description: "Service account used by the Marketplace deployer to create Kubernetes resources during installation."
    x-google-marketplace:
      type: SERVICE_ACCOUNT
      serviceAccount:
        description: "Used by deployer to create, update, patch, delete Deployments, Services, RBAC resources, and ConfigMaps during installation and cleanup."
        roles:
          # CRITICAL FIX #2: Expanded RBAC permissions with patch, delete, and additional API groups
          - type: ClusterRole
            rulesType: CUSTOM
            rules:
              # Core resources - expanded permissions
              - apiGroups: [""]
                resources: ["pods", "services", "serviceaccounts", "configmaps", "secrets", "persistentvolumeclaims", "events"]
                verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]
              # Apps resources - full CRUD permissions
              - apiGroups: ["apps"]
                resources: ["deployments", "statefulsets", "replicasets", "daemonsets"]
                verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]
              # RBAC resources - full permissions for setup and cleanup
              - apiGroups: ["rbac.authorization.k8s.io"]
                resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
                verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]
              # Application CRD resources (required by Marketplace)
              - apiGroups: ["app.k8s.io"]
                resources: ["applications"]
                verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]
              # Networking resources (if using Ingress)
              - apiGroups: ["networking.k8s.io"]
                resources: ["ingresses", "networkpolicies"]
                verbs: ["get", "list", "create", "update", "patch", "delete"]
              # Batch jobs (for deployer job itself)
              - apiGroups: ["batch"]
                resources: ["jobs"]
                verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]

# CRITICAL FIX #1: Added reportingSecret to required fields
required:
  - APP_INSTANCE_NAME
  - NAMESPACE
  - DOMAIN
  - reportingSecret
  - deployerServiceAccount
